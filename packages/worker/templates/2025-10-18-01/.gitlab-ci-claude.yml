# GitLab CI configuration for Claude AI implementation
# This pipeline implements tasks using Claude Agent SDK

stages:
  - prepare
  - execute
  - report

variables:
  WORKER_IMAGE: "oven/bun:latest"
  GIT_SUBMODULE_STRATEGY: recursive

workflow:
  rules:
    # Only run on API/pipeline triggers or when SYNC_ONLY is set
    - if: '$CI_PIPELINE_SOURCE == "api"'
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'
    - if: '$SYNC_ONLY == "true"'
    # Block all other automatic triggers (push, merge_request, etc.)
    - when: never

sync-only:
  stage: prepare
  image: $WORKER_IMAGE
  tags:
    - claude
  script:
    - echo "Syncing workspace repositories only (SYNC_ONLY mode)"
    - echo "Installing git..."
    - apt-get update && apt-get install -y git
    - git config --global user.email "${GITLAB_USER_EMAIL:-ci@gitlab.com}"
    - git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"

    # Configure git credentials for pushing
    - |
      if [ -n "$WORKER_REPO_TOKEN" ]; then
        git config --global credential.helper store
        echo "https://oauth2:${WORKER_REPO_TOKEN}@gitlab.com" > ~/.git-credentials
        echo "‚úì Worker repository credentials configured"
      fi
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "https://oauth2:${GITLAB_TOKEN}@gitlab.com" >> ~/.git-credentials
        echo "‚úì Workspace credentials configured"
      fi

    - cd 2025-10-18-01/worker-scripts
    - bun install
    - bun run sync-workspaces.ts
    - echo "‚úì Submodules synced successfully"
  cache:
    paths:
      - 2025-10-18-01/worker-scripts/node_modules/
  rules:
    - if: '$SYNC_ONLY == "true"'

prepare:
  stage: prepare
  image: $WORKER_IMAGE
  tags:
    - claude
  script:
    - echo "Installing dependencies for Claude implementation pipeline"
    - echo "Installing git..."
    - apt-get update && apt-get install -y git
    - git config --global user.email "${GITLAB_USER_EMAIL:-ci@gitlab.com}"
    - git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"

    - cd 2025-10-18-01/worker-scripts
    - bun install

    - echo "SESSION_ID=$SESSION_ID"
    - echo "PIPELINE_EXECUTION_ID=$PIPELINE_EXECUTION_ID"
    - echo "PROJECT_ID=$PROJECT_ID"

    # Debug: Check if API credentials are available
    - |
      if [ -z "$API_BASE_URL" ]; then
        echo "‚ö†Ô∏è  Warning: API_BASE_URL is not set"
      else
        echo "‚úì API_BASE_URL is set: $API_BASE_URL"
      fi
    - |
      if [ -z "$API_TOKEN" ]; then
        echo "‚ùå Error: API_TOKEN is not set - workspace sync will fail"
      else
        echo "‚úì API_TOKEN is set (length: ${#API_TOKEN})"
      fi

    # Sync all workspace repositories
    - echo "Syncing workspace repositories"
    - bun run sync-workspaces.ts
  cache:
    paths:
      - 2025-10-18-01/worker-scripts/node_modules/
  rules:
    - if: '$SYNC_ONLY == "true"'
      when: never
    - when: always

execute:
  stage: execute
  image: $WORKER_IMAGE
  tags:
    - claude
  script:
    # Install git if not available
    - echo "Installing git..."
    - apt-get update && apt-get install -y git curl
    - git config --global user.email "${GITLAB_USER_EMAIL:-ci@gitlab.com}"
    - git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"

    # Clean up orphaned .git/modules entries before initializing submodules
    - echo "üßπ Cleaning up orphaned .git/modules entries..."
    - |
      if [ -d ".git/modules/2025-10-18-01/workspaces" ]; then
        REGISTERED=$(git config --file .gitmodules --get-regexp path | grep "2025-10-18-01/workspaces" | awk '{print $2}' | xargs -I {} basename {} || true)
        for entry in $(ls -1 .git/modules/2025-10-18-01/workspaces 2>/dev/null || true); do
          IS_REGISTERED=$(echo "$REGISTERED" | grep -x "$entry" || true)
          if [ -z "$IS_REGISTERED" ]; then
            echo "   Removing orphaned: $entry"
            rm -rf ".git/modules/2025-10-18-01/workspaces/$entry"
          fi
        done
      fi
    - echo "‚úì Cleanup completed"

    # Initialize submodules
    - echo "üîÑ Initializing submodules..."
    - git submodule update --init --recursive 2025-10-18-01/workspaces/
    - echo "‚úì Submodules initialized"

    # Clean up old results from previous runs
    - rm -rf 2025-10-18-01/results
    - echo "‚úì Cleaned up old results directory"

    - cd 2025-10-18-01/worker-scripts

    # Debug: Check if required variables are set
    - echo "SESSION_ID=$SESSION_ID"
    - echo "PIPELINE_EXECUTION_ID=$PIPELINE_EXECUTION_ID"
    - echo "PROJECT_ID=$PROJECT_ID"
    - |
      if [ -z "$API_BASE_URL" ]; then
        echo "‚ö†Ô∏è  Warning: API_BASE_URL is not set"
      else
        echo "‚úì API_BASE_URL is set: $API_BASE_URL"
      fi
    - |
      if [ -z "$API_TOKEN" ]; then
        echo "‚ùå Error: API_TOKEN is not set"
      else
        echo "‚úì API_TOKEN is set (length: ${#API_TOKEN})"
      fi
    - |
      if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo "‚ùå Error: ANTHROPIC_API_KEY is not set"
      else
        echo "‚úì ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
      fi

    # Update status to 'running'
    - |
      if [ -n "$API_BASE_URL" ]; then
        bun -e "await fetch(process.env.API_BASE_URL + '/pipeline-executions/' + process.env.PIPELINE_EXECUTION_ID, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + process.env.API_TOKEN, 'Content-Type': 'application/json' }, body: JSON.stringify({status:'running'}) })"
      else
        echo "‚ö†Ô∏è  API_BASE_URL not set, skipping status update"
      fi

    # Run Claude implementation pipeline and capture exit code
    - bun run claude-pipeline.ts || EXIT_CODE=$?
    - EXIT_CODE=${EXIT_CODE:-0}

    # Update status based on exit code
    - |
      if [ -n "$API_BASE_URL" ]; then
        if [ $EXIT_CODE -eq 0 ]; then
          bun -e "await fetch(process.env.API_BASE_URL + '/pipeline-executions/' + process.env.PIPELINE_EXECUTION_ID, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + process.env.API_TOKEN, 'Content-Type': 'application/json' }, body: JSON.stringify({status:'success'}) })"
        else
          bun -e "await fetch(process.env.API_BASE_URL + '/pipeline-executions/' + process.env.PIPELINE_EXECUTION_ID, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + process.env.API_TOKEN, 'Content-Type': 'application/json' }, body: JSON.stringify({status:'failed'}) })"
        fi
      else
        echo "‚ö†Ô∏è  API_BASE_URL not set, skipping status update"
      fi
      exit $EXIT_CODE
  artifacts:
    paths:
      - 2025-10-18-01/results/
    expire_in: 7 days
  cache:
    paths:
      - 2025-10-18-01/worker-scripts/node_modules/
    policy: pull
  rules:
    - if: '$SYNC_ONLY == "true"'
      when: never
    - when: always

report:
  stage: report
  image: $WORKER_IMAGE
  tags:
    - claude
  script:
    # Debug: Check if artifacts were downloaded
    - ls -la 2025-10-18-01/ || echo "Directory not found"
    - ls -la 2025-10-18-01/results/ || echo "Results directory not found"

    # Install git for pushing changes to file spaces
    - echo "Installing git..."
    - apt-get update && apt-get install -y git
    - git config --global user.email "${GITLAB_USER_EMAIL:-ci@adi-pipeline.dev}"
    - git config --global user.name "${GITLAB_USER_NAME:-ADI Pipeline}"

    - cd 2025-10-18-01/worker-scripts

    # Upload implementation artifacts via our API (includes pushing to file spaces and creating MRs)
    - bun run upload-results.ts
  dependencies:
    - execute
  cache:
    paths:
      - 2025-10-18-01/worker-scripts/node_modules/
    policy: pull
  rules:
    - if: '$SYNC_ONLY == "true"'
      when: never
    - when: always
