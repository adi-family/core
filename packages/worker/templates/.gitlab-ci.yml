# Root GitLab CI configuration
# The RUNNER_TYPE variable is passed when triggering the pipeline to select the appropriate config

# Disable automatic submodule initialization during checkout to prevent conflicts
# Jobs that need workspaces will initialize them explicitly after cleanup
variables:
  GIT_SUBMODULE_STRATEGY: none

stages:
  - debug
  - prepare
  - execute
  - report

# Debug job - always runs first to show what config will be used
debug:routing:
  stage: debug
  image: alpine:latest
  script:
    - echo "========================================="
    - echo "üîç CI PIPELINE ROUTING DEBUG"
    - echo "========================================="
    - echo ""
    - echo "üìã Pipeline Variables:"
    - echo "  RUNNER_TYPE = ${RUNNER_TYPE:-<not set>}"
    - echo "  SESSION_ID = ${SESSION_ID:-<not set>}"
    - echo "  PIPELINE_EXECUTION_ID = ${PIPELINE_EXECUTION_ID:-<not set>}"
    - echo "  PROJECT_ID = ${PROJECT_ID:-<not set>}"
    - echo "  SYNC_ONLY = ${SYNC_ONLY:-<not set>}"
    - |
      if [ "$MOCK_MODE" = "true" ]; then
        echo "  üé≠ MOCK_MODE = true (AI API calls will be mocked)"
      else
        echo "  MOCK_MODE = ${MOCK_MODE:-<not set>} (real AI API calls)"
      fi
    - echo ""
    - echo "üéØ Pipeline Source:"
    - echo "  CI_PIPELINE_SOURCE = $CI_PIPELINE_SOURCE"
    - echo "  CI_COMMIT_REF_NAME = $CI_COMMIT_REF_NAME"
    - echo ""
    - echo "üö¶ Routing Decision:"
    - |
      if [ "$RUNNER_TYPE" = "evaluation" ]; then
        echo "  ‚úÖ Will use: .gitlab-ci-evaluation.yml"
        echo "  üè∑Ô∏è  Runner tags: evaluation"
      elif [ "$RUNNER_TYPE" = "claude" ] || [ "$RUNNER_TYPE" = "implementation" ]; then
        echo "  ‚úÖ Will use: .gitlab-ci-claude.yml"
        echo "  üè∑Ô∏è  Runner tags: claude"
      else
        echo "  ‚ùå ERROR: RUNNER_TYPE not recognized or not set!"
        echo "  Expected: 'evaluation', 'claude', or 'implementation'"
        exit 1
      fi
    - echo ""
    - echo "========================================="
  rules:
    - if: '$RUNNER_TYPE'  # Only run debug when RUNNER_TYPE is set
      when: always
    - when: never
  allow_failure: false

# Sync workspaces on push to main branch
sync:workspaces:
  stage: prepare
  image: oven/bun:latest
  script:
    - echo "üîÑ Syncing workspace submodules (triggered by push to $CI_COMMIT_REF_NAME)"
    - apt-get update && apt-get install -y git
    - git config --global user.email "ci@adi-pipeline.dev"
    - git config --global user.name "ADI Pipeline"

    # Aggressive cleanup of all orphaned .git/modules entries
    - echo "üßπ Cleaning up ALL .git/modules entries for fresh sync..."
    - |
      if [ -d ".git/modules/2025-10-18-01/workspaces" ]; then
        echo "Removing entire .git/modules/2025-10-18-01/workspaces directory..."
        rm -rf ".git/modules/2025-10-18-01/workspaces"
        echo "‚úì Removed all cached submodule data"
      fi
      if [ -d "2025-10-18-01/workspaces" ]; then
        echo "Removing physical workspaces directory..."
        rm -rf "2025-10-18-01/workspaces"
        echo "‚úì Removed physical workspaces"
      fi
      echo "‚úì Cleanup completed - fresh sync will recreate everything"

    # Configure git credentials if available
    - |
      if [ -n "$WORKER_REPO_TOKEN" ]; then
        git config --global credential.helper store
        echo "https://oauth2:${WORKER_REPO_TOKEN}@gitlab.com" > ~/.git-credentials
        echo "‚úì Worker repository credentials configured"
      fi
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "https://oauth2:${GITLAB_TOKEN}@gitlab.com" >> ~/.git-credentials
        echo "‚úì Workspace credentials configured"
      fi

    - cd 2025-10-18-01/worker-scripts
    - bun install
    - bun run sync-workspaces.ts
    - echo "‚úì Workspaces synced successfully"
  cache:
    paths:
      - 2025-10-18-01/worker-scripts/node_modules/
  rules:
    - if: '$SYNC_ONLY == "true"'  # Triggered by admin refresh
      when: always
    - if: '$CI_PIPELINE_SOURCE == "push" && $PROJECT_ID'  # Triggered by git push
      when: always
    - when: never

include:
  # Evaluation pipeline
  - local: '2025-10-18-01/.gitlab-ci-evaluation.yml'
    rules:
      - if: '$RUNNER_TYPE == "evaluation"'

  # Implementation pipeline (claude)
  - local: '2025-10-18-01/.gitlab-ci-claude.yml'
    rules:
      - if: '$RUNNER_TYPE == "claude"'
      - if: '$RUNNER_TYPE == "implementation"'
