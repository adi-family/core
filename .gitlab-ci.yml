stages:
  - lint
  - typecheck
  - deploy

variables:
  BUN_VERSION: "1.1.38"

.bun_template:
  image: oven/bun:${BUN_VERSION}
  before_script:
    - bun install --frozen-lockfile
  cache:
    key:
      files:
        - bun.lockb
    paths:
      - node_modules/

lint:
  extends: .bun_template
  stage: lint
  script:
    - bun run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

typecheck:
  extends: .bun_template
  stage: typecheck
  script:
    - bunx tsc --noEmit
    - bunx tsc -b client --force
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

deploy:
  image: alpine:latest
  stage: deploy
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST "http://in.the-ihor.com/api/v1/deploy?uuid=gcg0csggookgkk4o0gccc0w0&force=false" \
        -H "Authorization: Bearer ${COOLIFY_DEPLOY_TOKEN}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
